include ./templates/examples.jade

- function ngModel(field,lang){return "data."+field.id+(lang?"."+lang:"");}

mixin subset(field)
	label= t12n(field.label)
	p(class="help-block")= t12n(field.details,{bydefault:""})
	div(dataname=field.id)
		pre {{dataname}}
		pre {{data}}
		pre {{env}}
		each sfield in field.fields
			+field(sfield)

mixin list(field)
	label= t12n(field.path+".label")
	p= t12n(field.details,{bydefault:""})

mixin oldlist()
	div
		fieldset(ng-repeat="("+lk+", "+lf+") in "+list.NgScope)

			//legend
			//	#{'h'+(3+list.depth)}.text-primary
			//		= list.items.label + "{{"+lk+"}}"
			//		small=' '+list.items.details
			input(type='text',class="ng-hide",ng-value=list.NgScope+"["+lk+"]._id",name=list.NgName+"[{{"+lk+"}}][_id]")
			each field in list.fields
				+field(field)
			div(class="fieldset-controls")
				- var unsetid = "'"+list.NgScope.replace(/^data./,'')+".'+"+lf+"._id";
				button(ng-if="navsave", class="btn btn-remove btn-danger pull-right", type='button', ng-click="deleteListItem("+list.NgScope+","+lk+","+unsetid+")")
					span(class="glyphicon glyphicon-remove")
					= " "+t12n("crud.bricks.list.remove")
				.input-group.list-sort-select
					span.input-group-addon
						span.glyphicon.glyphicon-sort
					select(class="form-control", ng-model=lf+"._order", ng-change="orderListItem("+list.NgScope+","+lk+")",ng-options="ork as ork*1+1 for (ork, ore) in "+list.NgScope+"")

		div(class="list-footer")
			input(class='btn btn-add btn-primary', type='button', value='Add',ng-click="addListItem("+list.parent.NgScope+",'"+list.id+"')")
	

mixin field(field)
	div.field
		label
			span= t12n(field.label)
			if field.i18n
				div(class="dropdown-toggle-hover i18n-selector")
					button(type="button") {{env.lang}} 
					ul(class="dropdown dropdown-right menu ")
						li(ng-repeat="lang in env.langlist", ng-class="{active:env.lang==lang}")
							.menu-item(ng-click="env.lang=lang") {{lang}}

		.input
			if field.i18n
				+field-i18n(field)
			else
				+field-validation(field)
				+#{field.template}(field)
			p.help= t12n(field.details,{bydefault:""})
				
				

mixin field-i18n(field)
	each lang in gw.textualization.langs
		div(class="lang",ng-hide="env.lang!='"+lang+"'")
			+field-validation(field,lang)
			+#{field.template}(field,lang)
				
mixin field-validation(field,lang)
	//.input-msgs
		//.msg.bg-alert Cuidado!

mixin text(field,lang)
	input(type='text', id=field.id, name=field.id, ng-model=ngModel(field,lang))
	pre {{data}}

mixin file(field,lang)
	div {{data.#{field.id}}}
	input(type='file', id=field.id, name=field.id)

mixin fileimg(field,lang)
	imagepicker(id=field.id, name=field.id, ng-model=ngModel(field,lang))

mixin textarea(field,lang)
	textarea(id=field.id, name=field.id, ng-model=ngModel(field,lang))

mixin editor(field,lang)
	textarea(id=field.id, name=field.id, ng-model=ngModel(field,lang))

mixin _editor(config)
	div(id=config.id+"_toolbar", style="display: none;")
		a(data-wysihtml5-command="bold")= t12n("crud.bricks.editor.bold")
		a(data-wysihtml5-command="italic")= t12n("crud.bricks.editor.italic")
		a(data-wysihtml5-command="foreColor", data-wysihtml5-command-value="red")= t12n("crud.bricks.editor.red")
		a(data-wysihtml5-command="foreColor", data-wysihtml5-command-value="green")= t12n("crud.bricks.editor.green")
		a(data-wysihtml5-command="foreColor", data-wysihtml5-command-value="blue")= t12n("crud.bricks.editor.blue")
		a(data-wysihtml5-command="createLink")= t12n("crud.bricks.editor.link")
		div(data-wysihtml5-dialog="createLink", style="display: none;")
			label= t12n("crud.bricks.editor.link")+":"
				input(data-wysihtml5-dialog-field="href", value="http://", class="text")
			a(data-wysihtml5-dialog-action="save")= t12n("crud.bricks.editor.insert")
			a(data-wysihtml5-dialog-action="cancel")= t12n("crud.bricks.editor.cancel")

	textarea(class=config.classes, class=['form-control','field-editor'], id=config.id, name=config.name, ng-model=config.value, html-editor="true")

mixin select(field,lang)
	select(id=field.id, name=field.id, ng-model=ngModel(field,lang))
		each option,i in field.values
			option(value=i)=option

mixin checkbox(field,lang)
	.checkbox.hidden-label
		input(type='checkbox', id=field.id, name=field.id, ng-model=ngModel(field,lang), ng-true-value='true', ng-false-value='false')
		label

mixin checkboxes(field,lang)
	each option,i in field.values
		.checkbox
			input(type='checkbox',  id=field.id, name=field.id+"["+i+"]", ng-model=ngModel(field,lang)+"."+i, ng-true-value='true', ng-false-value='false')
			label=option

mixin radios(field,lang)
	each option,i in field.values
		.radio
			input(type='radio', id=field.id, name=field.id, ng-model=ngModel(field,lang), value=i)
			label=option

mixin time(field,lang)
	datepicker(id=field.id, ng-model=ngModel(field,lang), name=field.id)

mixin reference(field,lang)
	reference(id=field.id, ng-model=ngModel(field,lang), name=field.id)





mixin crudListActions
	form(class="form-inline", ng-controller="crudListActions")
		.field
			.input
				.inputaddons
					.addon
						label
							span(class="fa fa-search") &nbsp;
							= t12n("crud.actions.search")
					input(type="text",ng-change="apiList.load()",placeholder="...", ng-model="apiList.filter")
		.field
			.input.dropdown-toggle-hover
				button(type="button")
					span(class="fa fa-th-list") &nbsp;
					= t12n("crud.actions.sort")
				ul(class="dropdown dropdown-right menu")
					each header, i in schema.headers
						li
							.menu-item(ng-click="apiList.sort='"+header+"';apiList.order=1;apiList.load();",ng-class="{'active':apiList.sort=='"+header+"' && apiList.order=='1'}")
								span(class="fa fa-sort-amount-asc") &nbsp;
								= t12n("schemas."+schema.id+".headers."+header)
						li
							.menu-item(ng-click="apiList.sort='"+header+"';apiList.order=-1;apiList.load();",ng-class="{'active':apiList.sort=='"+header+"' && apiList.order=='1'}")
								span(class="fa fa-sort-amount-desc") &nbsp;
								= t12n("schemas."+schema.id+".headers."+header)
						if i<schema.headers.length-1
							li(role="presentation" class="divider")
		.field
			.input
				button(type="button")
					span(class="fa fa-plus") &nbsp;
					= t12n("crud.actions.new")

mixin crudList(schema)
	#view-top
		#view-header
			ol#breadcrumb
				li
					a(href="#")= t12n("crud.home")
				li
					a(href="#")= t12n("crud.admin")
			#view-title= t12n("schemas."+schema.id+".h1")

			#actions
				+crudListActions


	#view-bottom
		#view-body
			+formtable
			.crudLister
				table(class="table")
					thead
						tr
							each header in schema.headers
								th(ng-class="{'active':apiList.sort=='"+header+"'}")
									span(class="ng-hide fa fa-sort-amount-asc", ng-show="apiList.sort=='"+header+"' && apiList.order==1") &nbsp;
									span(class="ng-hide fa fa-sort-amount-desc", ng-show="apiList.sort=='"+header+"' && apiList.order==-1") &nbsp;
									= t12n("schemas."+schema.id+".headers."+header)
							th.corner &nbsp;

					tbody
						tr(ng-repeat="record in apiList.list")
							each header in schema.headers
								td="{{record."+header+"}}"
							td
								a(href="#/edit/{{record._id}}",class="button bg-action", role="button")
									span(class="fa fa-pencil")
									= " "+t12n("crud.list.edit")
								button(class="bg-danger", type='button', ng-click="removeRecord(record._id)")
									span(class="fa fa-times")
									= " "+t12n("crud.list.remove")
					tfoot
						tr
							td(colspan=schema.headers.length+1)
								div(class="loader")
									div(class="msg msg-icon bg-danger",ng-hide="!apiList.error")= t12n("crud.errors.apiList")

									button(class="bg-action loadnext", type='button', ng-click="apiList.loadnext();", ng-hide="apiList.end || apiList.loader.running")
										span(class="fa fa-forward")
										= " "+t12n("crud.actions.nextskip")
									
									div(class="msg loading bg-info",ng-hide="!apiList.loader.running")
										.fa.fa-spinner.fa-spin
										= t12n("crud.loading")

									div(class="progress sending",ng-hide="apiList.loader.sending==0 || !apiList.loader.running")
										span(style="width:{{apiList.loader.sending}}%;")
											span
												span(class="fa fa-upload")
												= t12n("crud.sending")+" {{apiList.loader.sending}}%"
									div(class="progress receiving",ng-hide="apiList.loader.receiving==0 || !apiList.loader.running")
										span(style="width:{{apiList.loader.receiving}}%;")
											span
												span(class="fa fa-download")
												= t12n("crud.receiving")+" {{apiList.loader.receiving}}%"

mixin crudEntity(schema)
	#view-top
		#view-header
			ol#breadcrumb
				li
					a(href="#")= t12n("crud.home")
				li
					a(href="#")= t12n("crud.admin")
			#view-title= t12n("schemas."+schema.id+".h1")

			#actions
				+crudListActions


	#view-bottom
		#view-body
			form(id="crudEntityForm", ng-submit="sendForm()", name="crudEntityForm")
				fieldset
					legend
						h3.text-primary= t12n("schemas."+schema.id+".title")
							small= " "+t12n("schemas."+schema.id+".details",{bydefault:""})

					div.unseters.ng-hide
						input(ng-repeat="(nstk,nst) in nstlist",ng-value="nst",name="unset[{{nstk}}]")

					.form-table
						each field in schema.fields
							if gw.user.can(field.need('see',true))
								if field.template=='subset' || field.template=='list' 
									+#{field.template}(field)
								else
									+field(field)

doctype html
html(lang=gw.language,ng-app="PillarsCRUD")
	head
		title= t12n("schemas."+schema.id+".title")
		meta(charset="utf-8")
		meta(http-equiv='X-UA-Compatible', content='IE=edge')
		meta(name="viewport", content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no")
		link(rel='stylesheet', type='text/css', href='/css/normalize.css')
		link(rel='stylesheet', type='text/css', href='/css/pillars.css')

	body
		#space
			#top
				header#header
					a(id="brand",href="#") Pillars
					div(id="user",class="dropdown-toggle-hover")
						img(id="user-img",src="/img/user.jpg")
						div(id="user-info")
							div(id="user-name") Javier Gallego Martín {{env.langlist}}
						ul(id="user-options",class="dropdown dropdown-right menu")
							li
								a(href="#") Preferences
								ul
									li
										a(href="#") Option A
									li
										a(href="#") Option B
							li
								a(href="#") Exit
			#bottom
				#left
					#navigation
						h2.nav-title t12n("backend.navigation-title")
						nav
							ul
								li
									a(href="#") System
								li
									a(href="#") Users
								li
									a(href="#") System
								li
									a(href="#") Users
								li
									a(href="#") System
								li
									a(href="#") Users
								li
									a(href="#") System
								li
									a(href="#") Users
								li
									a(href="#") System
								li
									a(href="#") Users
								li
									a(href="#") System
								li
									a(href="#") Users
				#right
					div(id="view",ng-view)

		script(type="text/ng-template", id="crudList.html")
			+crudList(schema)
		script(type="text/ng-template", id="crudEntity.html")
			+crudEntity(schema)

		link(rel='stylesheet', type='text/css', href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,600,600italic,700,700italic')
		link(rel="stylesheet", type='text/css', href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css")
		script(src='https://code.angularjs.org/snapshot/angular.min.js')
		script(src='https://code.angularjs.org/snapshot/i18n/angular-locale_'+gw.language+'.js')
		script(src='https://code.angularjs.org/snapshot/angular-route.min.js')
		//script(src='https://code.angularjs.org/snapshot/angular-animate.min.js')
		script(src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js')
		//script(src='//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js')
		script(src='/js/kinetic-v5.1.0.min.js')
		script(src='/js/wysihtml5-advanced.js')
		script(src='/js/wysihtml5-0.4.0pre.js')

		script(src='/js/pillars/classes.js')
		script(src='/js/pillars/services.js')
		script(src='/js/pillars/controllers.js')
		script(src='/js/pillars/filters.js')
		script(src='/js/pillars/directives.js')
		script(type='text/javascript').
			angular.module('PillarsCRUD', [
				'ngRoute',
				'Pillars.filters',
				'Pillars.services',
				'Pillars.directives',
				'Pillars.controllers'
			])
				.config(['$routeProvider', function($routeProvider) {
					$routeProvider
						.when('/', {
							controller:'crudList',
							templateUrl:'crudList.html'
						})
						.when('/edit/:_id', {
							controller:'crudUpdate',
							templateUrl:'crudEntity.html'
						})
						.when('/new', {
							controller:'crudInsert',
							templateUrl:'crudEntity.html'
						})
						.otherwise({
							redirectTo:'/'
						});
				}])
				.run(function ($rootScope) {
					$rootScope.env = {
						apiurl : 'http://#{gw.host}#{gw.pillar.path}/api',
						lang : '#{gw.language}',
						langlist : ['#{gw.textualization.langs.join("','")}']
					}
				})
			;





